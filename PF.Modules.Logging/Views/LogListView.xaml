<UserControl
    x:Class="PF.Modules.Logging.Views.LogListView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:local="clr-namespace:PF.Modules.Logging.Converter"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:pf="clr-namespace:PF.UI.Controls;assembly=PF.UI.Controls"
    xmlns:prism="http://prismlibrary.com/"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    d:DesignHeight="600"
    d:DesignWidth="900"
    mc:Ignorable="d">

    <UserControl.Resources>
        <!--  转换器  -->
        <local:LogLevelToBrushConverter x:Key="LogLevelToBrushConverter" />
        <local:LogLevelToSymbolConverter x:Key="LogLevelToSymbolConverter" />
        <local:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <local:NullToTextConverter x:Key="NullToTextConverter" NullText="全部" />
        <local:ExceptionToExpanderVisibilityConverter x:Key="ExceptionToExpanderVisibilityConverter" />

        <!-- 修改 LogItemStyle 添加行为 -->
        <Style x:Key="LogItemStyle" TargetType="ListViewItem">
            <Setter Property="BorderThickness" Value="0,0,0,1" />
            <Setter Property="BorderBrush" Value="#E0E0E0" />
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Focusable" Value="True" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Cursor" Value="Hand" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#F5F7FA" />
                </Trigger>
                <MultiTrigger>
                    <MultiTrigger.Conditions>
                        <Condition Property="IsSelected" Value="True" />
                    </MultiTrigger.Conditions>
                    <Setter Property="Background" Value="#E3F2FD" />
                    <Setter Property="BorderBrush" Value="#2196F3" />
                    <Setter Property="BorderThickness" Value="1" />
                </MultiTrigger>
            </Style.Triggers>
        </Style>

       
        <!--  日志项模板  -->
        <DataTemplate x:Key="LogEntryTemplate">
            <Border Padding="4,2" Background="Transparent">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" MinHeight="0" />
                    </Grid.RowDefinitions>

                    <!--  时间  -->
                    <TextBlock
                        Grid.Column="0"
                        Margin="0,0,12,0"
                        VerticalAlignment="Top"
                        FontFamily="Consolas"
                        FontSize="11"
                        Foreground="#666"
                        Text="{Binding Timestamp, StringFormat='HH:mm:ss.fff'}" />

                    <!--  级别图标  -->
                    <TextBlock
                        Grid.Column="1"
                        Width="24"
                        Margin="0,0,8,0"
                        VerticalAlignment="Top"
                        FontSize="14"
                        Text="{Binding Level, Converter={StaticResource LogLevelToSymbolConverter}}"
                        TextAlignment="Center"
                        ToolTip="{Binding Level}" />

                    <!--  级别标签  -->
                    <Border
                        Grid.Column="2"
                        Margin="0,0,12,0"
                        Padding="6,2"
                        VerticalAlignment="Top"
                        Background="{Binding Level, Converter={StaticResource LogLevelToBrushConverter}}"
                        CornerRadius="4">
                        <TextBlock
                            VerticalAlignment="Center"
                            FontSize="10"
                            FontWeight="SemiBold"
                            Text="{Binding Level}" />
                    </Border>

                    <!--  消息  -->
                    <TextBlock
                        Grid.Column="3"
                        Margin="0,0,8,0"
                        VerticalAlignment="Top"
                        FontSize="13"
                        Text="{Binding Message}"
                        TextWrapping="Wrap" />

                    <!--  类别标签  -->
                    <Border
                        Grid.Column="4"
                        Margin="0,0,8,0"
                        Padding="4,2"
                        VerticalAlignment="Top"
                        Background="#E8F5E9"
                        BorderBrush="#C8E6C9"
                        BorderThickness="1"
                        CornerRadius="3"
                        Visibility="{Binding Category, Converter={StaticResource NullToVisibilityConverter}}">
                        <TextBlock
                            VerticalAlignment="Center"
                            FontSize="10"
                            FontWeight="Medium"
                            Foreground="#388E3C"
                            Text="{Binding Category}" />
                    </Border>

                    <!--  异常指示器  -->
                    <Border
                        Grid.Column="5"
                        Padding="4,2"
                        Background="#FFEBEE"
                        BorderBrush="#FFCDD2"
                        BorderThickness="1"
                        CornerRadius="3"
                        Visibility="{Binding Exception, Converter={StaticResource NullToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock
                                Margin="0,0,2,0"
                                FontSize="10"
                                Text="⚠️" />
                            <TextBlock
                                FontSize="10"
                                FontWeight="Medium"
                                Foreground="#D32F2F"
                                Text="异常" />
                        </StackPanel>
                    </Border>

                    <!--  异常详情（只有有异常的项在选中时才显示）  -->
                    <Border
                        Grid.Row="1"
                        Grid.Column="0"
                        Grid.ColumnSpan="6"
                        Margin="0,4,0,0"
                        Padding="8"
                        BorderBrush="#FFCDD2"
                        BorderThickness="1"
                        CornerRadius="4">
                        <Border.Visibility>
                            <MultiBinding Converter="{StaticResource ExceptionToExpanderVisibilityConverter}">
                                <Binding Path="Exception" />
                                <Binding Path="IsSelected" RelativeSource="{RelativeSource AncestorType=ListViewItem}" />
                            </MultiBinding>
                        </Border.Visibility>
                        <StackPanel>
                            <TextBlock
                                FontSize="12"
                                FontWeight="Medium"
                                Foreground="#D32F2F"
                                Text="{Binding Exception.Message}"
                                TextWrapping="Wrap" />
                            <TextBlock
                                Margin="0,4,0,0"
                                FontFamily="Consolas"
                                FontSize="11"
                                Foreground="#666"
                                Text="{Binding Exception.StackTrace}"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  工具栏  -->
        <Border
            Grid.Row="0"
            Padding="12,8"
            BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!--  筛选工具栏  -->
                <StackPanel
                    Grid.Column="0"
                    Margin="0,0,20,0"
                    Orientation="Horizontal">
                    <TextBlock
                        Margin="0,0,8,0"
                        VerticalAlignment="Center"
                        FontWeight="SemiBold"
                        Text="筛选：" />

                    <!--  日志级别  -->
                    <ComboBox
                        Width="120"
                        Height="28"
                        Margin="0,0,12,0"
                        VerticalAlignment="Center"
                        ItemsSource="{Binding LogLevels}"
                        SelectedItem="{Binding SelectedLogLevel}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock
                                        Width="20"
                                        Margin="0,0,6,0"
                                        Text="{Binding Converter={StaticResource LogLevelToSymbolConverter}}"
                                        TextAlignment="Center" />
                                    <TextBlock VerticalAlignment="Center" Text="{Binding Converter={StaticResource NullToTextConverter}}" />
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>

                    <!--  日期范围  -->
                    <ComboBox
                        Width="100"
                        Height="28"
                        VerticalAlignment="Center"
                        DisplayMemberPath="Name"
                        ItemsSource="{Binding DateRanges}"
                        SelectedItem="{Binding SelectedDateRange}" />
                </StackPanel>

                <!--  搜索框  -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBox
                        Width="200"
                        Height="28"
                        Padding="8,0"
                        VerticalAlignment="Center"
                        Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}">
                        <TextBox.ToolTip>
                            <TextBlock>
                                <Run Text="支持搜索：" /><LineBreak />
                                <Run Text="• 日志内容" /><LineBreak />
                                <Run Text="• 分类名称" /><LineBreak />
                                <Run Text="• 异常信息" />
                            </TextBlock>
                        </TextBox.ToolTip>
                    </TextBox>
                </StackPanel>

                <!--  操作按钮  -->
                <StackPanel
                    Grid.Column="2"
                    Margin="20,0"
                    Orientation="Horizontal">
                    <Button
                        Width="60"
                        Height="28"
                        Margin="0,0,8,0"
                        Command="{Binding RefreshCommand}"
                        Content="刷新"
                        ToolTip="刷新日志列表" />

                    <Button
                        Width="60"
                        Height="28"
                        Margin="0,0,8,0"
                        Command="{Binding ClearLogsCommand}"
                        Content="清空"
                        Style="{StaticResource ButtonDanger}"
                        ToolTip="清空所有日志" />

                    <Button
                        Width="60"
                        Height="28"
                        Margin="0,0,8,0"
                        Command="{Binding ExportLogsCommand}"
                        Content="导出"
                        Style="{StaticResource ButtonPrimary}"
                        ToolTip="导出当前显示的日志" />
                </StackPanel>

                <!--  统计信息  -->
                <Border
                    Grid.Column="3"
                    Padding="8,4"
                    HorizontalAlignment="Center"
                    BorderThickness="1"
                    CornerRadius="4">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock
                            Margin="0,0,8,0"
                            VerticalAlignment="Center"
                            FontSize="14"
                            Text="📊" />
                        <TextBlock
                            VerticalAlignment="Center"
                            FontWeight="SemiBold"
                            Text="{Binding FilteredLogCount, StringFormat='显示 {0} 条'}" />
                        <TextBlock
                            Margin="4,0,0,0"
                            VerticalAlignment="Center"
                            Foreground="#666"
                            Text="{Binding TotalLogCount, StringFormat=' / 总计 {0} 条'}" />
                    </StackPanel>
                </Border>

                <!--  控制选项  -->
                <StackPanel Grid.Column="4" Orientation="Horizontal">
                    <CheckBox
                        Margin="0,0,12,0"
                        VerticalAlignment="Center"
                        Content="自动滚动"
                        IsChecked="{Binding AutoScroll}" />

                    <Button
                        Width="80"
                        Height="28"
                        Margin="0,0,8,0"
                        Command="{Binding CopySelectedCommand}"
                        Content="📋复制"
                        Style="{StaticResource ButtonDashed}"
                        ToolTip="复制选中日志" />

                    <Button
                        Width="80"
                        Height="28"
                        Command="{Binding CopyAllCommand}"
                        Content="📋复制全部"
                        Style="{StaticResource ButtonDashed}"
                        ToolTip="复制所有显示的日志" />
                </StackPanel>
            </Grid>
        </Border>

        <!--  日志列表  -->
        <Border Grid.Row="1">
            <Grid>
                <ListView
                    x:Name="LogListViewControl"
                    BorderThickness="0"
                    Focusable="True"
                    ItemContainerStyle="{StaticResource LogItemStyle}"
                    ItemTemplate="{StaticResource LogEntryTemplate}"
                    ItemsSource="{Binding LogEntriesView}"
                    ScrollViewer.CanContentScroll="True"
                    ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                    SelectedItem="{Binding SelectedLogEntry, Mode=TwoWay}"
                    SelectionMode="Single"
                    VirtualizingPanel.IsVirtualizing="True"
                    VirtualizingPanel.ScrollUnit="Item"
                    VirtualizingPanel.VirtualizationMode="Standard">
                    <ListView.GroupStyle>
                        <GroupStyle>
                            <GroupStyle.HeaderTemplate>
                                <DataTemplate>
                                    <Border Padding="12,8" BorderThickness="0,0,0,1">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock
                                                FontSize="13"
                                                FontWeight="Bold"
                                                Foreground="#495057"
                                                Text="{Binding Name, StringFormat='📅 {0}'}" />
                                            <TextBlock
                                                Margin="8,0,0,0"
                                                VerticalAlignment="Center"
                                                FontSize="11"
                                                Foreground="#6C757D"
                                                Text="{Binding ItemCount, StringFormat=' ({0} 条)'}" />
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </GroupStyle.HeaderTemplate>
                        </GroupStyle>
                    </ListView.GroupStyle>
                </ListView>

                <!--  空状态提示  -->
                <Border
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    Visibility="{Binding LogEntriesView.IsEmpty, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel
                        Margin="0,0,0,80"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center">
                        <Path
                            Width="80"
                            Height="80"
                            Margin="0,0,0,16"
                            Data="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"
                            Fill="#E9ECEF"
                            Stretch="Uniform" />
                        <TextBlock
                            Margin="0,0,0,8"
                            HorizontalAlignment="Center"
                            FontSize="18"
                            FontWeight="Medium"
                            Foreground="#6C757D"
                            Text="暂无日志" />
                        <TextBlock
                            HorizontalAlignment="Center"
                            FontSize="14"
                            Foreground="#ADB5BD"
                            Text="应用程序的日志将在这里显示" />
                    </StackPanel>
                </Border>

                <!--  加载指示器  -->
                <Border Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                        <pf:LoadingLine />
                        <TextBlock
                            Margin="0,12,0,0"
                            Foreground="#666"
                            Text="正在加载日志..." />
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- 状态栏 -->
        <Border Grid.Row="2"
                BorderThickness="0,1,0,0"
                Padding="12,6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- 状态信息 - 添加选中项信息 -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="{Binding SelectedLogLevel, Converter={StaticResource NullToTextConverter}, StringFormat='筛选：{0}'}"
                             VerticalAlignment="Center"
                             Foreground="#666"
                             FontSize="12"/>

                    <!-- 显示选中项信息 -->
                    <TextBlock Text="{Binding SelectedLogEntry.Message, StringFormat=' | 选中：{0}'}"
                             VerticalAlignment="Center"
                             Foreground="#2196F3"
                             FontSize="12"
                             Margin="20,0,0,0"
                             FontWeight="SemiBold"
                             Visibility="{Binding SelectedLogEntry, Converter={StaticResource NullToVisibilityConverter}}"/>
                </StackPanel>

                <!-- 时间 -->
                <TextBlock Grid.Column="1"
                         Text="{Binding Source={x:Static sys:DateTime.Now}, StringFormat='最后更新：{0:HH:mm:ss}'}"
                         VerticalAlignment="Center"
                         Foreground="#666"
                         FontSize="12"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>