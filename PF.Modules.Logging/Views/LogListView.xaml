<UserControl
    x:Class="PF.Modules.Logging.Views.LogListView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:local="clr-namespace:PF.Modules.Logging.Converter"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:pf="clr-namespace:PF.UI.Controls;assembly=PF.UI.Controls"
    xmlns:prism="http://prismlibrary.com/"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    d:DesignHeight="600"
    d:DesignWidth="900"
    mc:Ignorable="d">

    <UserControl.Resources>
        <local:LogLevelToBrushConverter x:Key="LogLevelToBrushConverter" />
        <local:LogLevelToSymbolConverter x:Key="LogLevelToSymbolConverter" />
        <local:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <local:NullToTextConverter x:Key="NullToTextConverter" NullText="全部" />
        <local:ExceptionToExpanderVisibilityConverter x:Key="ExceptionToExpanderVisibilityConverter" />

        <Style x:Key="LogItemStyle" TargetType="ListViewItem">
            <Setter Property="BorderThickness" Value="0,0,0,1" />
            <Setter Property="BorderBrush" Value="#E0E0E0" />
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="Focusable" Value="True" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="ContextMenu">
                <Setter.Value>
                    <ContextMenu>
                        <MenuItem Command="{Binding DataContext.CopySelectedCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" Header="复制选中内容">
                            <MenuItem.Icon>
                                <TextBlock Text="📋" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <MenuItem Command="{Binding DataContext.CopyAllCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" Header="复制全部显示内容">
                            <MenuItem.Icon>
                                <TextBlock Text="📑" />
                            </MenuItem.Icon>
                        </MenuItem>

                        <Separator />
                        <MenuItem Command="{Binding DataContext.ClearLogsCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" Header="清空日志">
                            <MenuItem.Icon>
                                <TextBlock Text="🆑" />
                            </MenuItem.Icon>
                        </MenuItem>
                        <MenuItem Command="{Binding DataContext.RefreshCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" Header="刷新">
                            <MenuItem.Icon>
                                <TextBlock Text="🔄️" />
                            </MenuItem.Icon>
                        </MenuItem>


                    </ContextMenu>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#F5F7FA" />
                </Trigger>
                <MultiTrigger>
                    <MultiTrigger.Conditions>
                        <Condition Property="IsSelected" Value="True" />
                    </MultiTrigger.Conditions>
                    <Setter Property="Background" Value="#E3F2FD" />
                    <Setter Property="BorderBrush" Value="#2196F3" />
                    <Setter Property="BorderThickness" Value="1" />
                </MultiTrigger>
            </Style.Triggers>
        </Style>

        <DataTemplate x:Key="LogEntryTemplate">
            <Border Padding="4,2" Background="Transparent">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" MinHeight="0" />
                    </Grid.RowDefinitions>

                    <TextBlock
                        Grid.Column="0"
                        Margin="0,0,12,0"
                        VerticalAlignment="Top"
                        FontFamily="Consolas"
                        FontSize="11"
                        Foreground="#666"
                        Text="{Binding Timestamp, StringFormat='HH:mm:ss.fff'}" />

                    <TextBlock
                        Grid.Column="1"
                        Width="24"
                        Margin="0,0,8,0"
                        VerticalAlignment="Top"
                        FontSize="14"
                        Text="{Binding Level, Converter={StaticResource LogLevelToSymbolConverter}}"
                        TextAlignment="Center"
                        ToolTip="{Binding Level}" />

                    <Border
                        Grid.Column="2"
                        Margin="0,0,12,0"
                        Padding="6,2"
                        VerticalAlignment="Top"
                        Background="{Binding Level, Converter={StaticResource LogLevelToBrushConverter}}"
                        CornerRadius="4">
                        <TextBlock
                            VerticalAlignment="Center"
                            FontSize="10"
                            FontWeight="SemiBold"
                            Text="{Binding Level}" />
                    </Border>

                    <TextBlock
                        Grid.Column="3"
                        Margin="0,0,8,0"
                        VerticalAlignment="Top"
                        FontSize="13"
                        Text="{Binding Message}"
                        TextWrapping="Wrap" />

                    <Border
                        Grid.Column="4"
                        Margin="0,0,8,0"
                        Padding="4,2"
                        VerticalAlignment="Top"
                        Background="#E8F5E9"
                        BorderBrush="#C8E6C9"
                        BorderThickness="1"
                        CornerRadius="3"
                        Visibility="{Binding Category, Converter={StaticResource NullToVisibilityConverter}}">
                        <TextBlock
                            VerticalAlignment="Center"
                            FontSize="10"
                            FontWeight="Medium"
                            Foreground="#388E3C"
                            Text="{Binding Category}" />
                    </Border>

                    <Border
                        Grid.Column="5"
                        Padding="4,2"
                        Background="#FFEBEE"
                        BorderBrush="#FFCDD2"
                        BorderThickness="1"
                        CornerRadius="3"
                        Visibility="{Binding Exception, Converter={StaticResource NullToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock
                                Margin="0,0,2,0"
                                FontSize="10"
                                Text="⚠️" />
                            <TextBlock
                                FontSize="10"
                                FontWeight="Medium"
                                Foreground="#D32F2F"
                                Text="异常" />
                        </StackPanel>
                    </Border>

                    <Border
                        Grid.Row="1"
                        Grid.Column="0"
                        Grid.ColumnSpan="6"
                        Margin="0,4,0,0"
                        Padding="8"
                        BorderBrush="#FFCDD2"
                        BorderThickness="1"
                        CornerRadius="4">
                        <Border.Visibility>
                            <MultiBinding Converter="{StaticResource ExceptionToExpanderVisibilityConverter}">
                                <Binding Path="Exception" />
                                <Binding Path="IsSelected" RelativeSource="{RelativeSource AncestorType=ListViewItem}" />
                            </MultiBinding>
                        </Border.Visibility>
                        <StackPanel>
                            <TextBlock
                                FontSize="12"
                                FontWeight="Medium"
                                Foreground="#D32F2F"
                                Text="{Binding Exception.Message}"
                                TextWrapping="Wrap" />
                            <TextBlock
                                Margin="0,4,0,0"
                                FontFamily="Consolas"
                                FontSize="11"
                                Foreground="#666"
                                Text="{Binding Exception.StackTrace}"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <pf:TransitioningContentControl TransitionMode="Right2LeftWithFade" TransitionStoryboard="{StaticResource Right2LeftWithFadeTransition}">

        <Border BorderBrush="{DynamicResource SecondaryBorderBrush}" BorderThickness="2">
            <Grid Margin="5">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <Border
                    Grid.Row="0"
                    Padding="12,8"
                    BorderThickness="0,0,0,1">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel
                            Grid.Column="0"
                            Margin="0,0,20,0"
                            Orientation="Horizontal">

                            <ComboBox
                                Width="110"
                                Height="28"
                                Margin="0,0,12,0"
                                VerticalAlignment="Center"
                                ItemsSource="{Binding LogLevels}"
                                SelectedItem="{Binding SelectedLogLevel}">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock
                                                Width="20"
                                                Margin="0,0,6,0"
                                                Text="{Binding Converter={StaticResource LogLevelToSymbolConverter}}"
                                                TextAlignment="Center" />
                                            <TextBlock VerticalAlignment="Center" Text="{Binding Converter={StaticResource NullToTextConverter}}" />
                                        </StackPanel>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>

                            <ComboBox
                                Width="100"
                                Height="28"
                                VerticalAlignment="Center"
                                DisplayMemberPath="Name"
                                ItemsSource="{Binding DateRanges}"
                                SelectedItem="{Binding SelectedDateRange}" />
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                            <pf:SearchBar
                                Width="240"
                                Height="28"
                                VerticalAlignment="Center"
                                Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                ToolTip="搜索日志内容、分类或异常信息" />
                        </StackPanel>

                        <StackPanel
                            Grid.Column="3"
                            HorizontalAlignment="Right"
                            Orientation="Horizontal">

                            <Border
                                Margin="0,0,16,0"
                                Padding="10,4"
                                Background="Transparent"
                                BorderThickness="0"
                                CornerRadius="4">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock
                                        Margin="0,0,6,0"
                                        VerticalAlignment="Center"
                                        FontSize="14"
                                        Text="📊" />
                                    <TextBlock
                                        VerticalAlignment="Center"
                                        FontWeight="SemiBold"
                                        Text="{Binding FilteredLogCount, StringFormat='显示 {0}'}" />
                                    <TextBlock
                                        Margin="4,0,0,0"
                                        VerticalAlignment="Center"
                                        Foreground="#999"
                                        Text="{Binding TotalLogCount, StringFormat='/ {0}'}" />
                                </StackPanel>
                            </Border>

                            <CheckBox
                                VerticalAlignment="Center"
                                Content="自动滚动"
                                IsChecked="{Binding AutoScroll}" />
                        </StackPanel>
                    </Grid>
                </Border>

                <Border Grid.Row="1">
                    <Grid>
                        <ListView
                            x:Name="LogListViewControl"
                            BorderThickness="0"
                            Focusable="True"
                            ItemContainerStyle="{StaticResource LogItemStyle}"
                            ItemTemplate="{StaticResource LogEntryTemplate}"
                            ItemsSource="{Binding LogEntriesView}"
                            ScrollViewer.CanContentScroll="True"
                            ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                            ScrollViewer.VerticalScrollBarVisibility="Auto"
                            SelectedItem="{Binding SelectedLogEntry, Mode=TwoWay}"
                            SelectionMode="Single"
                            VirtualizingPanel.IsVirtualizing="True"
                            VirtualizingPanel.ScrollUnit="Item"
                            VirtualizingPanel.VirtualizationMode="Standard">
                            <ListView.GroupStyle>
                                <GroupStyle>
                                    <GroupStyle.HeaderTemplate>
                                        <DataTemplate>
                                            <Border Padding="12,8" BorderThickness="0,0,0,1">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock
                                                        FontSize="13"
                                                        FontWeight="Bold"
                                                        Foreground="#495057"
                                                        Text="{Binding Name, StringFormat='📅 {0}'}" />
                                                    <TextBlock
                                                        Margin="8,0,0,0"
                                                        VerticalAlignment="Center"
                                                        FontSize="11"
                                                        Foreground="#6C757D"
                                                        Text="{Binding ItemCount, StringFormat=' ({0} 条)'}" />
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </GroupStyle.HeaderTemplate>
                                </GroupStyle>
                            </ListView.GroupStyle>
                        </ListView>

                        <Border
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch"
                            Visibility="{Binding LogEntriesView.IsEmpty, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel
                                Margin="0,0,0,80"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center">
                                <Path
                                    Width="64"
                                    Height="64"
                                    Margin="0,0,0,16"
                                    Data="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"
                                    Fill="#F1F3F5"
                                    Stretch="Uniform" />
                                <TextBlock
                                    HorizontalAlignment="Center"
                                    FontSize="14"
                                    Foreground="#ADB5BD"
                                    Text="暂无符合条件的日志" />
                            </StackPanel>
                        </Border>

                        <Border Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                <pf:LoadingLine />
                                <TextBlock
                                    Margin="0,12,0,0"
                                    Foreground="#666"
                                    Text="正在加载..." />
                            </StackPanel>
                        </Border>
                    </Grid>
                </Border>

                <Border
                    Grid.Row="2"
                    Padding="12,4"
                    BorderThickness="0,1,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                            <TextBlock
                                VerticalAlignment="Center"
                                FontSize="12"
                                Foreground="#2196F3"
                                Text="{Binding SelectedLogEntry.Message, StringFormat='选中：{0}'}"
                                TextTrimming="CharacterEllipsis"
                                Visibility="{Binding SelectedLogEntry, Converter={StaticResource NullToVisibilityConverter}}" />
                        </StackPanel>

                        <TextBlock
                            Grid.Column="1"
                            VerticalAlignment="Center"
                            FontSize="12"
                            Foreground="#999"
                            Text="{Binding Source={x:Static sys:DateTime.Now}, StringFormat='最后更新：{0:HH:mm:ss}'}" />
                    </Grid>
                </Border>
            </Grid>
        </Border>
    </pf:TransitioningContentControl>
</UserControl>